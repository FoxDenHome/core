on:
  push:
    branches:
      - main

concurrency:
  cancel-in-progress: true
  group: deploy-${{ github.ref }}

jobs:
  deploy:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        target: [bengalfox.foxden.network, islandfox.foxden.network, icefox.foxden.network]
    steps:
      - uses: https://data.forgejo.org/actions/checkout@v6
      - name: Deploy to target
        run: |
          echo "Deploying to target: ${{ matrix.target }}"
          systemctl --no-block start nixos-update
          journalctl --unit nixos-update --since=now --no-hostname -f |
              awk '/service: Deactivated successfully/ { print; exit; }; { print; }'
