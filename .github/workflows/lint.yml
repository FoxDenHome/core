on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  cancel-in-progress: true
  group: lint-${{ github.ref }}

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: https://data.forgejo.org/actions/checkout@v4
      #TODO: Uncomment once we have Forgejo 12 (node24 act support), for now we bake uv into runner image
      #- uses: https://github.com/astral-sh/setup-uv@v7
      - uses: https://github.com/cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          github_access_token: ${{ secrets.EXT_GITHUB_TOKEN }}
      - name: Lint nix
        run: |
          cd ./nix
          nix run 'nixpkgs#nixfmt-tree' -- --ci
      - name: Lint mikrotik
        run: |
          cd ./mikrotik
          uv run ruff check

      - uses: https://github.com/terraform-linters/setup-tflint@v5
        name: Setup TFLint
        with:
          tflint_version: v0.59.1

      - name: Init TFLint
        run: tflint --init

      - name: Run TFLint
        run: tflint -c "${PWD}/terraform/.tflint.hcl" --recursive -f compact
